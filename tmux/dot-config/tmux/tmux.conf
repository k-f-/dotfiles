# =============================================================================
# tmux configuration
# =============================================================================
# Designed for persistent Mac Mini server sessions accessed from iPad + laptop.
# Prefix: Ctrl-A (ThePrimeagen style, no conflicts with AeroSpace or Kitty)
#
# Plugin stack:
#   tpm           - plugin manager
#   sensible      - sane defaults everyone agrees on
#   resurrect     - persist sessions across reboots (prefix + Ctrl-s / Ctrl-r)
#   continuum     - auto-save every 15 min + auto-restore on start
#   yank          - system clipboard integration (critical for iPad)
#   catppuccin    - theme (swap for dracula if you prefer)
#
# TPM install (run once):
#   git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/plugins/tpm
#   Then: prefix + I  (capital i) to install plugins
# =============================================================================

# ---------------------------------------------------------------------------
# Prefix
# ---------------------------------------------------------------------------
# Modifier domains:  Alt+Shift = AeroSpace,  Ctrl+Shift = Kitty,  Ctrl+A = tmux
# Ctrl+A: easy to hit, works on iPad. To send literal Ctrl+A (readline BOL), press Ctrl+A twice.
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# ---------------------------------------------------------------------------
# General
# ---------------------------------------------------------------------------
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"
set -s escape-time 0                  # no delay after escape (vim sanity)
set -g history-limit 50000            # generous scrollback
set -g base-index 1                   # windows start at 1
setw -g pane-base-index 1             # panes start at 1
set -g renumber-windows on            # renumber on close
set -g set-titles on                  # set terminal title
set -g set-titles-string "#S / #W"    # session / window in title bar
set -g detach-on-destroy off          # switch to another session on destroy
set -g focus-events on                # pass focus events to apps
set -g display-time 3000              # status messages last 3s
set -g status-interval 5              # refresh status every 5s

# ---------------------------------------------------------------------------
# Mouse (critical for iPad)
# ---------------------------------------------------------------------------
set -g mouse on

# ---------------------------------------------------------------------------
# Clipboard (OSC 52 — remote-to-local clipboard via terminal)
# ---------------------------------------------------------------------------
# Enables clipboard sync from remote tmux sessions to local terminal.
# Requires a terminal that supports OSC 52 (Kitty, iTerm2, etc.).
# Works with Eternal Terminal (et) — does NOT work with mosh.
set -g set-clipboard on
set -g allow-passthrough on

# ---------------------------------------------------------------------------
# Vi mode
# ---------------------------------------------------------------------------
setw -g mode-keys vi

# Vi-style copy mode
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# Enter copy mode
bind v copy-mode

# ---------------------------------------------------------------------------
# Window & pane management
# ---------------------------------------------------------------------------
# Intuitive splits (in current directory)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"

# Pane navigation (prefix + vim keys)
bind -r h select-pane -L
bind -r j select-pane -D
bind -r k select-pane -U
bind -r l select-pane -R

# Resize panes (with prefix + Shift)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Window switching: prefix + 1-9 (tmux default, works everywhere)
# Last window toggle (prefix + ^)
bind -r ^ last-window

# ---------------------------------------------------------------------------
# ThePrimeagen niceties
# ---------------------------------------------------------------------------
# Fuzzy project switcher (prefix + f)
bind-key -r f run-shell "tmux neww ~/.config/tmux/scripts/tmux-sessionizer"

# Quick TODO (prefix + D) — opens TODO.md in cwd or falls back to personal
bind -r D neww -c "#{pane_current_path}" \
  "[[ -e TODO.md ]] && nvim TODO.md || nvim ~/Documents/todo.md"

# Reload config (prefix + r)
bind r source-file ~/.config/tmux/tmux.conf \; display "Config reloaded"

# ---------------------------------------------------------------------------
# Session switching
# ---------------------------------------------------------------------------
# Session picker (prefix + s is tmux default, adding tree view on prefix + S)
bind S choose-tree -Zs

# ---------------------------------------------------------------------------
# Status bar (overridden by catppuccin, but good fallback)
# ---------------------------------------------------------------------------
set -g status-position top
set -g status-style "bg=default,fg=default"
set -g status-left-length 40
set -g status-left "#[bold] [#S] "
set -g status-right "%H:%M "

# ---------------------------------------------------------------------------
# Plugins (managed by TPM)
# ---------------------------------------------------------------------------
# Plugin directory — keep everything under XDG config
set-environment -g TMUX_PLUGIN_MANAGER_PATH '~/.config/tmux/plugins/'

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-yank'

# --- tmux-resurrect ---
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'

# --- tmux-continuum ---
# Auto-save every 15 min, auto-restore on tmux start
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'

# --- tmux-yank ---
set -g @yank_with_mouse 'on'

# --- catppuccin theme ---
# Install: git clone -b v2.1.3 https://github.com/catppuccin/tmux.git \
#          ~/.config/tmux/plugins/catppuccin/tmux
# Or use TPM (uncomment below, remove manual source):
# set -g @plugin 'catppuccin/tmux#v2.1.3'
set -g @catppuccin_flavor "mocha"
set -g @catppuccin_window_status_style "rounded"

# Load catppuccin (manual install — more reliable than TPM for themes)
# Comment this out if using TPM for catppuccin instead
run -b '[ -f ~/.config/tmux/plugins/catppuccin/tmux/catppuccin.tmux ] && \
  ~/.config/tmux/plugins/catppuccin/tmux/catppuccin.tmux'

# Catppuccin status line customization (only applies if catppuccin loaded)
set -g status-right-length 100
set -g status-left-length 100

# ---------------------------------------------------------------------------
# Initialize TPM (MUST be last line)
# ---------------------------------------------------------------------------
run '~/.config/tmux/plugins/tpm/tpm'
