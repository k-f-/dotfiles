#!/usr/bin/env bash

# show-keybindings-html - Display keybindings in browser

[[ -f "${HOME}/.config/dotfiles/env" ]] && source "${HOME}/.config/dotfiles/env"
DOTFILES="${DOTFILES_DIR:?DOTFILES_DIR not set — run ./install first}"

KEYBINDINGS_FILE="${DOTFILES}/docs/KEYBINDINGS.md"

if [[ ! -f "$KEYBINDINGS_FILE" ]]; then
    echo "Error: Keybindings file not found at $KEYBINDINGS_FILE" >&2
    exit 1
fi

# Create temporary HTML file
TEMP_HTML=$(mktemp /tmp/keybindings.XXXXXX.html)

# Convert markdown to HTML with styling
cat > "$TEMP_HTML" <<'HTML_START'
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Keybindings Reference</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
            line-height: 1.6;
        }
        h1 {
            color: #4ec9b0;
            border-bottom: 2px solid #4ec9b0;
            padding-bottom: 10px;
        }
        h2 {
            color: #569cd6;
            margin-top: 30px;
            border-bottom: 1px solid #3e3e3e;
            padding-bottom: 5px;
        }
        h3 {
            color: #dcdcaa;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: #252526;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #3e3e3e;
        }
        th {
            background: #2d2d30;
            color: #4ec9b0;
            font-weight: 600;
        }
        tr:hover {
            background: #2a2d2e;
        }
        code, kbd {
            background: #1e1e1e;
            border: 1px solid #3e3e3e;
            border-radius: 3px;
            padding: 2px 6px;
            font-family: "Monaco", "Menlo", monospace;
            color: #ce9178;
        }
        .paradigm-box {
            background: #264f78;
            border-left: 4px solid #4ec9b0;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .paradigm-box strong {
            color: #4ec9b0;
        }
        ul {
            list-style-type: none;
            padding-left: 0;
        }
        ul li::before {
            content: "▸ ";
            color: #4ec9b0;
        }
        hr {
            border: none;
            border-top: 1px solid #3e3e3e;
            margin: 30px 0;
        }
    </style>
</head>
<body>
HTML_START

# Convert markdown to HTML using awk
awk '
BEGIN {
    in_table = 0;
    in_list = 0;
}

# Headers
/^# / {
    gsub(/^# /, "");
    printf "<h1>%s</h1>\n", $0;
    next;
}
/^## / {
    if (in_table) { print "</table>"; in_table = 0; }
    if (in_list) { print "</ul>"; in_list = 0; }
    gsub(/^## /, "");
    printf "<h2>%s</h2>\n", $0;
    next;
}
/^### / {
    if (in_table) { print "</table>"; in_table = 0; }
    if (in_list) { print "</ul>"; in_list = 0; }
    gsub(/^### /, "");
    printf "<h3>%s</h3>\n", $0;
    next;
}

# Horizontal rule
/^---$/ {
    if (in_table) { print "</table>"; in_table = 0; }
    if (in_list) { print "</ul>"; in_list = 0; }
    print "<hr>";
    next;
}

# Lists
/^- / {
    if (in_table) { print "</table>"; in_table = 0; }
    if (!in_list) { print "<ul>"; in_list = 1; }
    gsub(/^- /, "");

    # Handle backticks
    while (match($0, /`([^`]*)`/)) {
        before = substr($0, 1, RSTART-1);
        code = substr($0, RSTART+1, RLENGTH-2);
        after = substr($0, RSTART+RLENGTH);
        $0 = before "<code>" code "</code>" after;
    }

    # Handle bold
    while (match($0, /\*\*([^*]+)\*\*/)) {
        before = substr($0, 1, RSTART-1);
        bold = substr($0, RSTART+2, RLENGTH-4);
        after = substr($0, RSTART+RLENGTH);
        $0 = before "<strong>" bold "</strong>" after;
    }

    printf "<li>%s</li>\n", $0;
    next;
}

# Table detection
/^\|/ {
    if (in_list) { print "</ul>"; in_list = 0; }

    # Skip separator lines
    if ($0 ~ /\|-+\|/) next;

    # Remove leading/trailing pipes
    line = $0;
    gsub(/^\| */, "", line);
    gsub(/ *\|$/, "", line);

    # Split by pipe
    split(line, cols, " *\\| *");

    # First table row (header)
    if (!in_table) {
        print "<table>";
        printf "<tr>";
        for (i = 1; i <= length(cols); i++) {
            # Handle backticks properly
            while (match(cols[i], /`([^`]*)`/)) {
                before = substr(cols[i], 1, RSTART-1);
                code = substr(cols[i], RSTART+1, RLENGTH-2);
                after = substr(cols[i], RSTART+RLENGTH);
                cols[i] = before "<code>" code "</code>" after;
            }
            printf "<th>%s</th>", cols[i];
        }
        printf "</tr>\n";
        in_table = 1;
    }
    # Data rows
    else {
        printf "<tr>";
        for (i = 1; i <= length(cols); i++) {
            # Handle backticks properly
            while (match(cols[i], /`([^`]*)`/)) {
                before = substr(cols[i], 1, RSTART-1);
                code = substr(cols[i], RSTART+1, RLENGTH-2);
                after = substr(cols[i], RSTART+RLENGTH);
                cols[i] = before "<code>" code "</code>" after;
            }
            printf "<td>%s</td>", cols[i];
        }
        printf "</tr>\n";
    }
    next;
}

# Empty lines end tables/lists
/^$/ {
    if (in_table) { print "</table>"; in_table = 0; }
    if (in_list) { print "</ul>"; in_list = 0; }
    print "<p></p>";
    next;
}

# Bold and inline code in regular text
{
    if (in_table) { print "</table>"; in_table = 0; }
    if (in_list) { print "</ul>"; in_list = 0; }

    # Handle backticks
    while (match($0, /`([^`]*)`/)) {
        before = substr($0, 1, RSTART-1);
        code = substr($0, RSTART+1, RLENGTH-2);
        after = substr($0, RSTART+RLENGTH);
        $0 = before "<code>" code "</code>" after;
    }

    # Handle bold
    while (match($0, /\*\*([^*]+)\*\*/)) {
        before = substr($0, 1, RSTART-1);
        bold = substr($0, RSTART+2, RLENGTH-4);
        after = substr($0, RSTART+RLENGTH);
        $0 = before "<strong>" bold "</strong>" after;
    }

    # Handle italic
    while (match($0, /\*([^*]+)\*/)) {
        before = substr($0, 1, RSTART-1);
        italic = substr($0, RSTART+1, RLENGTH-2);
        after = substr($0, RSTART+RLENGTH);
        $0 = before "<em>" italic "</em>" after;
    }

    print;
}

END {
    if (in_table) print "</table>";
    if (in_list) print "</ul>";
}
' "$KEYBINDINGS_FILE" >> "$TEMP_HTML"

cat >> "$TEMP_HTML" <<'HTML_END'
</body>
</html>
HTML_END

# Open in default browser
open "$TEMP_HTML"

# Clean up after 5 seconds (browser will have loaded it by then)
(sleep 5 && rm -f "$TEMP_HTML") &
