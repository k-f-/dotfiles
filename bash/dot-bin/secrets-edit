#!/usr/bin/env bash
set -euo pipefail

# Decrypt ~/.secrets-env.gpg → edit in $EDITOR → re-encrypt → shred plaintext
# Usage: secrets-edit

SECRETS_GPG="$HOME/.secrets-env.gpg"
SECRETS_PLAIN="$HOME/.secrets-env"
GPG_RECIPIENT="kyle@fring.io"

if [ ! -f "$SECRETS_GPG" ]; then
    echo "No secrets file found at $SECRETS_GPG"
    echo "Create one with: secrets-edit --init"

    if [ "${1:-}" = "--init" ]; then
        cat > "$SECRETS_PLAIN" <<'EOF'
# Shell secrets - GPG encrypted, decrypted at shell startup
# Edit with: secrets-edit

# export EXAMPLE_TOKEN="value"
EOF
        ${EDITOR:-vim} "$SECRETS_PLAIN"
    else
        exit 1
    fi
else
    gpg -q --for-your-eyes-only --no-tty -d "$SECRETS_GPG" > "$SECRETS_PLAIN"
    chmod 600 "$SECRETS_PLAIN"
    ${EDITOR:-vim} "$SECRETS_PLAIN"
fi

if [ -f "$SECRETS_PLAIN" ]; then
    gpg --yes --output "$SECRETS_GPG" --encrypt --recipient "$GPG_RECIPIENT" "$SECRETS_PLAIN"

    # Secure delete — overwrite before removing
    if command -v shred >/dev/null 2>&1; then
        shred -u "$SECRETS_PLAIN"
    elif command -v gshred >/dev/null 2>&1; then
        gshred -u "$SECRETS_PLAIN"
    else
        rm -P "$SECRETS_PLAIN" 2>/dev/null || rm "$SECRETS_PLAIN"
    fi

    echo "Secrets encrypted and plaintext removed."
    echo "Restart your shell (or source ~/.bashrc.d/secrets.bash) to load changes."
fi
